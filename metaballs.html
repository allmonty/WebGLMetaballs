<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>Metaballs</title>

<script id="simple-vert-shader" type="x-shader/x-vertex">
    attribute vec4 vPosition;
    attribute vec4 vColor;

    uniform mat4 modelView;
    uniform mat4 projection;

    uniform mat4 rotation;
    uniform mat4 translate;
    uniform mat4 scale;

    varying vec4 fColor;

    void
    main()
    {
        gl_Position = projection * modelView * translate * rotation * scale *vPosition;
        fColor = vColor;
    }
</script>

<script id="simple-frag-shader" type="x-shader/x-fragment">
    precision mediump float;

    varying vec4 fColor;

    void
    main()
    {
        gl_FragColor = fColor;
    }
</script>

<script id="metaball-vert-shader" type="x-shader/x-vertex">
    attribute vec4 vPosition;
    attribute vec4 vColor;

    uniform mat4 modelView;
    uniform mat4 projection;

    uniform mat4 rotation;
    uniform mat4 translate;
    uniform mat4 scale;

    varying vec4 fColor;
    varying vec4 fPosition;

    void
    main()
    {
        fPosition = translate * rotation * scale * vPosition;
        gl_Position = projection * modelView * fPosition;
        fColor = vColor;
    }
</script>

<script id="metaball-frag-shader" type="x-shader/x-fragment">
    precision mediump float;

    const int numOfBalls        = 4;
    const float numOfRaySteps   = 100.0;

    uniform vec4 camEye;
    uniform vec4 ballsPos[numOfBalls];
    uniform vec4 ballsColors[numOfBalls];

    varying vec4 fPosition;

    vec4 nearestPoint   = vec4(0.0, 0.0, 0.0, 1.0);
    vec4 farthestPoint  = vec4(0.0, 0.0, 0.0, 1.0);

    vec4 drawColor  = vec4(0.0, 0.0, 0.0, 0.0);

    int hittedBalls[numOfBalls];
    int hasHitted   = 0;

    void calculatePoints(vec4 startPos, vec4 rayDir, float ballRadius)
    {
        vec4 ballDir, ballPosInRay;
        float ballRayDot;
        vec4 enterPoint, exitPoint;
        float A, B, C; //Sides in the pythagoras theorem
        for(int i = 0; i < numOfBalls; i++)
        {
            ballDir         = ballsPos[i] - startPos;
            ballRayDot      = dot(rayDir, ballDir);
            ballPosInRay    = ballRayDot * rayDir + startPos;

            if(abs(distance(ballPosInRay, ballsPos[i])) < ballRadius)
            {
                A = distance(ballPosInRay, ballsPos[i]);
                B = ballRadius;
                C = sqrt(A*A + B*B);

                enterPoint = startPos + rayDir*(ballRayDot - C);
                exitPoint  = startPos + rayDir*(ballRayDot + C);

                if(distance(enterPoint, startPos) < distance(nearestPoint, startPos) ||
                    hasHitted == 0)
                {
                    nearestPoint = enterPoint;
                }

                if(distance(exitPoint, startPos) > distance(farthestPoint, startPos)||
                    hasHitted == 0)
                {
                    farthestPoint = exitPoint;
                }

                hittedBalls[i] = 1;
                hasHitted = 1;
            }
            else if(abs(distance(ballPosInRay, ballsPos[i])) == ballRadius)
            {
                if(distance(ballPosInRay, startPos) < distance(nearestPoint, startPos) ||
                    hasHitted == 0)
                {
                    nearestPoint = enterPoint;
                }

                if(distance(ballPosInRay, startPos) > distance(farthestPoint, startPos)||
                    hasHitted == 0)
                {
                    farthestPoint = exitPoint;
                }

                hittedBalls[i] = 1;
                hasHitted = 1;
            }
            else
            {
                hittedBalls[i] = 0;
            }
        }
    }

    // #define M_PI 3.1415926535897932384626433832795;
    float metaballFormula(float d)
    {
        // return d * d * d * (d * (d * 6.0 - 15.0) + 10.0);
        // return d*d*d*d - d*d + 0.25;
        // return (cos(d*3.1416*4.0 + 3.1416) + 1.0)/2.0;
        return (1.0 - d*d)*(1.0 - d*d);
    }

    // float threshold = 0.12;
    float threshold = 0.5;

    void
    main()
    {
        vec4 startPos   = fPosition;
        vec4 rayDir     = normalize(fPosition - camEye);

        float ballsRadius = 1.0;
        calculatePoints(startPos, rayDir, ballsRadius);

        if(hasHitted == 1)
        {
            float rayLength = distance(nearestPoint, farthestPoint);
            float rayStep = rayLength/numOfRaySteps;

            vec4 actualPoint = nearestPoint;
            float chargeSum = 0.0;

            int shouldRender = 0;

            for(float i = 0.0; i <= numOfRaySteps; i += 1.0)
            {
                actualPoint = actualPoint + rayDir*rayStep;
                for(int j = 0; j < numOfBalls; j += 1)
                {
                    if(hittedBalls[j] == 1)
                    {
                        float dist = distance(actualPoint, ballsPos[j])/ballsRadius;
                        if(dist <= 1.0)
                        {
                            // chargeSum += metaballFormula(1.0 - dist);
                            float charge = metaballFormula(dist);
                            chargeSum += charge;
                            drawColor += charge*ballsColors[j];
                        }
                    }
                }

                if(chargeSum >= threshold)
                {
                    shouldRender = 1;
                    break;
                }
                else
                {
                    chargeSum = 0.0;
                    drawColor = vec4(0.0, 0.0, 0.0, 0.0);
                }
            }

            if(shouldRender == 1)
            {
                gl_FragColor = normalize(drawColor);
            }
            else
            {
                discard;
            }
        }
        else
        {
            discard;
        }
    }
</script>

<script type="text/javascript" src="./metaball/webgl-utils.js"></script>
<script type="text/javascript" src="./metaball/initshaders.js"></script>
<script type="text/javascript" src="./metaball/mv.js"></script>
<script type="text/javascript" src="./metaball/smallextlib_mv.js"></script>
<script type="text/javascript" src="./metaball/models.js"></script>
<script type="text/javascript" src="./metaball/renderobject.js"></script>
<script type="text/javascript" src="./metaball/main_metaballs.js"></script>
</head>   

<body>
<center>
<div id="fps">
    oioioi
</div>
<canvas id="gl-canvas" width="700" height="500">
    Oops ... your browser doesn't support the HTML5 canvas element
</canvas>
    
</center>
</body></html>